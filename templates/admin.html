{% extends "base.html" %}

{% block title %}Admin | Sodienye & Ayoade{% endblock %}

{% block extra_css %}
<style>
    /* Admin-specific styles will be added here */
</style>
{% endblock %}

{% block content %}
<!-- Admin Section -->
<section class="admin-page">
    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Admin Panel</h2>
            <div class="section-divider"></div>
            <p class="section-subtitle">Manage your wedding website content</p>
            <a href="{{ url_for('admin_logout') }}" class="btn btn-secondary" style="margin-top: 20px;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="admin-tabs">
            <button class="tab-button active" data-tab="settings">Settings</button>
            <button class="tab-button" data-tab="media">Media Upload</button>
        </div>
        
        <!-- Settings Tab -->
        <div class="tab-content active" id="settings-tab">
            <form action="{{ url_for('admin_update') }}" method="POST" class="admin-form">
                <div class="form-section">
                    <h3>White Wedding Details</h3>
                    
                    <div class="form-group">
                        <label for="white_wedding_date">Date</label>
                        <input type="text" id="white_wedding_date" name="white_wedding_date" value="{{ data.white_wedding.date }}" placeholder="e.g., April 12, 2026 (Date TBD)">
                    </div>
                    
                    <div class="form-group">
                        <label for="white_wedding_time">Time</label>
                        <input type="text" id="white_wedding_time" name="white_wedding_time" value="{{ data.white_wedding.time }}" placeholder="e.g., 11:00 AM WAT">
                    </div>
                    
                    <div class="form-group">
                        <label for="white_wedding_venue">Venue</label>
                        <input type="text" id="white_wedding_venue" name="white_wedding_venue" value="{{ data.white_wedding.venue }}" placeholder="e.g., TBD">
                    </div>
                    
                    <div class="form-group">
                        <label for="white_wedding_address">Address</label>
                        <input type="text" id="white_wedding_address" name="white_wedding_address" value="{{ data.white_wedding.address }}" placeholder="e.g., Details to be announced">
                    </div>
                    
                    <div class="form-group">
                        <label for="white_wedding_location">Location Label</label>
                        <input type="text" id="white_wedding_location" name="white_wedding_location" value="{{ data.white_wedding.location }}" placeholder="e.g., Location TBD">
                    </div>
                    
                    <div class="form-group">
                        <label for="white_wedding_map">Google Maps Embed Code</label>
                        <textarea id="white_wedding_map" name="white_wedding_map" rows="4" placeholder="Paste the iframe embed code here">{{ data.white_wedding.map_embed }}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="white_wedding_rsvp_link">White Wedding RSVP Form URL</label>
                        <input type="url" id="white_wedding_rsvp_link" name="white_wedding_rsvp_link" value="{{ data.white_wedding.rsvp_link }}" placeholder="https://forms.gle/your-white-wedding-rsvp-link">
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>White Wedding Reception Details</h3>
                    
                    <div class="form-group">
                        <label for="reception_date">Date</label>
                        <input type="text" id="reception_date" name="reception_date" value="{{ data.white_wedding_reception.date }}" placeholder="e.g., April 12, 2026 (Date TBD)">
                    </div>
                    
                    <div class="form-group">
                        <label for="reception_time">Time</label>
                        <input type="text" id="reception_time" name="reception_time" value="{{ data.white_wedding_reception.time }}" placeholder="e.g., 4:00 PM WAT">
                    </div>
                    
                    <div class="form-group">
                        <label for="reception_venue">Venue</label>
                        <input type="text" id="reception_venue" name="reception_venue" value="{{ data.white_wedding_reception.venue }}" placeholder="e.g., TBD">
                    </div>
                    
                    <div class="form-group">
                        <label for="reception_address">Address</label>
                        <input type="text" id="reception_address" name="reception_address" value="{{ data.white_wedding_reception.address }}" placeholder="e.g., Details to be announced">
                    </div>
                    
                    <div class="form-group">
                        <label for="reception_location">Location Label</label>
                        <input type="text" id="reception_location" name="reception_location" value="{{ data.white_wedding_reception.location }}" placeholder="e.g., Location TBD">
                    </div>
                    
                    <div class="form-group">
                        <label for="reception_map">Google Maps Embed Code</label>
                        <textarea id="reception_map" name="reception_map" rows="4" placeholder="Paste the iframe embed code here">{{ data.white_wedding_reception.map_embed }}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="reception_rsvp_link">Reception RSVP Form URL</label>
                        <input type="url" id="reception_rsvp_link" name="reception_rsvp_link" value="{{ data.white_wedding_reception.rsvp_link }}" placeholder="https://forms.gle/your-reception-rsvp-link">
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>Contact Information</h3>
                    
                    <div class="form-group">
                        <label for="whatsapp">WhatsApp Number</label>
                        <input type="text" id="whatsapp" name="whatsapp" value="{{ data.contact.whatsapp }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Wedding Email</label>
                        <input type="email" id="email" name="email" value="{{ data.contact.email }}">
                    </div>
                </div>
                
                <div class="form-section">
                    <h3>RSVP Link</h3>
                    
                    <div class="form-group">
                        <label for="rsvp_link">RSVP Form URL</label>
                        <input type="url" id="rsvp_link" name="rsvp_link" value="{{ data.rsvp_link }}" placeholder="https://forms.gle/your-rsvp-link">
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary btn-large">Save Changes</button>
            </form>
        </div>
        
        <!-- Media Upload Tab -->
        <div class="tab-content" id="media-tab">
            <div class="upload-sections">
                <!-- Hero Media -->
                <div class="upload-section">
                    <h3>Hero Slideshow</h3>
                    <p>Photos and videos for the homepage hero section</p>
                    
                    <div class="upload-area" data-folder="hero">
                        <input type="file" id="hero-upload" multiple accept="image/*,video/*" style="display: none;">
                        <label for="hero-upload" class="upload-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Click or drag files here</span>
                        </label>
                        <div class="upload-progress" style="display: none;">
                            <div class="progress-bar"></div>
                        </div>
                    </div>
                    
                    <div class="media-preview" id="hero-preview">
                        <!-- Uploaded media will appear here -->
                    </div>
                </div>
                
                <!-- Proposal Media -->
                <div class="upload-section">
                    <h3>Proposal Story</h3>
                    <p>Photos and videos for the proposal section</p>
                    
                    <div class="upload-area" data-folder="proposal">
                        <input type="file" id="proposal-upload" multiple accept="image/*,video/*" style="display: none;">
                        <label for="proposal-upload" class="upload-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Click or drag files here</span>
                        </label>
                        <div class="upload-progress" style="display: none;">
                            <div class="progress-bar"></div>
                        </div>
                    </div>
                    
                    <div class="media-preview" id="proposal-preview">
                        <!-- Uploaded media will appear here -->
                    </div>
                </div>
                
                <!-- Gallery Media -->
                <div class="upload-section">
                    <h3>Gallery</h3>
                    <p>Photos and videos for the gallery section</p>
                    
                    <div class="upload-area" data-folder="gallery">
                        <input type="file" id="gallery-upload" multiple accept="image/*,video/*" style="display: none;">
                        <label for="gallery-upload" class="upload-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Click or drag files here</span>
                        </label>
                        <div class="upload-progress" style="display: none;">
                            <div class="progress-bar"></div>
                        </div>
                    </div>
                    
                    <div class="media-preview" id="gallery-preview">
                        <!-- Uploaded media will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
// Tab functionality
document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
        const tabId = button.dataset.tab;
        
        // Update active tab button
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        button.classList.add('active');
        
        // Update active tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabId + '-tab').classList.add('active');
    });
});

// Media upload functionality
const uploadAreas = document.querySelectorAll('.upload-area');

uploadAreas.forEach(area => {
    const folder = area.dataset.folder;
    const fileInput = area.querySelector('input[type="file"]');
    const preview = document.getElementById(folder + '-preview');
    
    // Load existing media
    loadMedia(folder, preview);
    
    // Handle file selection
    fileInput.addEventListener('change', (e) => {
        handleFileUpload(e.target.files, folder, preview, area);
    });
    
    // Drag and drop
    area.addEventListener('dragover', (e) => {
        e.preventDefault();
        area.classList.add('drag-over');
    });
    
    area.addEventListener('dragleave', () => {
        area.classList.remove('drag-over');
    });
    
    area.addEventListener('drop', (e) => {
        e.preventDefault();
        area.classList.remove('drag-over');
        handleFileUpload(e.dataTransfer.files, folder, preview, area);
    });
});

function loadMedia(folder, previewContainer) {
    fetch(`/admin/media/${folder}`)
        .then(response => response.json())
        .then(data => {
            displayMedia(data.files, previewContainer, folder);
        })
        .catch(error => console.error('Error loading media:', error));
}

function handleFileUpload(files, folder, previewContainer, uploadArea) {
    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }
    
    const progressBar = uploadArea.querySelector('.progress-bar');
    const progressContainer = uploadArea.querySelector('.upload-progress');
    
    progressContainer.style.display = 'block';
    
    fetch(`/admin/upload/${folder}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        progressContainer.style.display = 'none';
        if (data.uploaded) {
            loadMedia(folder, previewContainer);
        }
    })
    .catch(error => {
        console.error('Error uploading files:', error);
        progressContainer.style.display = 'none';
    });
}

function displayMedia(files, container, folder) {
    container.innerHTML = '';
    
    if (files.length === 0) {
        container.innerHTML = '<p class="no-media">No media uploaded yet</p>';
        return;
    }
    
    files.forEach(file => {
        const mediaItem = document.createElement('div');
        mediaItem.className = 'media-item';
        
        if (file.type === 'image') {
            mediaItem.innerHTML = `
                <img src="${file.url}" alt="${file.name}">
                <button class="delete-btn" onclick="deleteMedia('${folder}', '${file.name}', this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
        } else {
            mediaItem.innerHTML = `
                <video controls>
                    <source src="${file.url}" type="video/mp4">
                </video>
                <button class="delete-btn" onclick="deleteMedia('${folder}', '${file.name}', this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
        }
        
        container.appendChild(mediaItem);
    });
}

function deleteMedia(folder, filename, button) {
    if (confirm('Are you sure you want to delete this file?')) {
        fetch(`/admin/media/${folder}/${filename}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload media for this folder
                const preview = document.getElementById(folder + '-preview');
                loadMedia(folder, preview);
            }
        })
        .catch(error => console.error('Error deleting media:', error));
    }
}
</script>
{% endblock %}